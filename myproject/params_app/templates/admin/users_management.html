{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    {% csrf_token %}
    <meta name="csrf-token" content="{{ csrf_token }}">
    <title>User Management - PARMS Admin</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/dashboard.css' %}">
</head>
<body>
    <button class="mobile-menu-toggle" onclick="toggleSidebar()">
        <i class="fas fa-bars"></i>
    </button>

    <div class="container-fluid">
        <div class="sidebar" id="sidebar">
            <a style="color: white; text-decoration: none; display: flex; align-items: center; margin-bottom: 30px;" class="navbar-brand" href="/">
                <img src="{% static 'imgs/Traffic Jam.png' %}" height="40px" style="margin-right: 10px;">
                <span><h1 style="margin: 0;">PARMS</h1></span>
            </a>
            <ul class="nav-items">
                <li class="nav-item"><a href="{% url 'dashboard' %}"><i class="fas fa-tachometer-alt"></i><span>Dashboard</span></a></li>
                <li class="nav-item"><a href="{% url 'admin_users_management' %}" style="background: rgba(255, 255, 255, 0.15);"><i class="fas fa-users"></i><span>Users</span></a></li>
                <li class="nav-item"><a href="{% url 'billings' %}"><i class="fas fa-file-invoice-dollar"></i><span>Billings</span></a></li>
                <li class="nav-item"><a href="{% url 'admin_parking_lots' %}"><i class="fas fa-map-marker-alt"></i><span>Locations</span></a></li>
                <li class="nav-item"><a href="{% url 'parkings' %}"><i class="fas fa-car"></i><span>Parkings</span></a></li>
                <li class="nav-item"><a href="{% url 'admin_contacts' %}"><i class="fas fa-envelope"></i><span>Messages</span></a></li>
                <li class="nav-item"><a href="{% url 'admin_tickets' %}"><i class="fas fa-ticket-alt"></i><span>Tickets</span></a></li>
                <li class="nav-item"><a href="{% url 'admin_reports' %}"><i class="fas fa-chart-bar"></i><span>Reports</span></a></li>
                <li class="nav-item"><a href="{% url 'settings' %}"><i class="fas fa-cog"></i><span>Settings</span></a></li>
            </ul>
        </div>

        <div class="main-content">
            <!-- Top Bar -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; padding: 20px; background: white; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                <div>
                    <h2 style="color: #198754; margin: 0; font-weight: bold;">ðŸ‘¥ User Management</h2>
                    <p style="color: #666; margin: 5px 0 0 0;">Manage system users and permissions</p>
                </div>
                <div style="display: flex; gap: 15px; align-items: center;">
                    <span style="background: #198754; color: white; padding: 5px 15px; border-radius: 20px; font-size: 14px; font-weight: bold;">
                        {{ total_users }} Total Users
                    </span>
                    <span style="background: #007bff; color: white; padding: 5px 15px; border-radius: 20px; font-size: 14px; font-weight: bold;">
                        {{ staff_count }} Staff
                    </span>
                    <select onchange="filterUsers(this.value)" style="padding: 10px 15px; border: 2px solid #e9ecef; border-radius: 25px; font-size: 14px; background: white; cursor: pointer;">
                        <option value="all" {% if current_type == 'all' %}selected{% endif %}>All Users</option>
                        <option value="staff" {% if current_type == 'staff' %}selected{% endif %}>Staff Only</option>
                        <option value="regular" {% if current_type == 'regular' %}selected{% endif %}>Regular Users</option>
                    </select>
                </div>
            </div>

            <!-- User Statistics -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px;">
                <div style="background: linear-gradient(135deg, #198754, #20c997); color: white; padding: 25px; border-radius: 10px; text-align: center; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                    <i class="fas fa-users" style="font-size: 36px; margin-bottom: 10px;"></i>
                    <h3 style="margin: 0;">{{ total_users }}</h3>
                    <p style="margin: 5px 0 0 0; opacity: 0.9;">Total Users</p>
                </div>
                
                <div style="background: linear-gradient(135deg, #007bff, #6610f2); color: white; padding: 25px; border-radius: 10px; text-align: center; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                    <i class="fas fa-user-shield" style="font-size: 36px; margin-bottom: 10px;"></i>
                    <h3 style="margin: 0;">{{ staff_count }}</h3>
                    <p style="margin: 5px 0 0 0; opacity: 0.9;">Staff Members</p>
                </div>
                
                <div style="background: linear-gradient(135deg, #28a745, #20c997); color: white; padding: 25px; border-radius: 10px; text-align: center; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                    <i class="fas fa-user" style="font-size: 36px; margin-bottom: 10px;"></i>
                    <h3 style="margin: 0;">{{ regular_count }}</h3>
                    <p style="margin: 5px 0 0 0; opacity: 0.9;">Regular Users</p>
                </div>
            </div>

            <!-- Users Table -->
            <div style="background: white; border-radius: 10px; padding: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                {% if users %}
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: #f8f9fa; border-bottom: 2px solid #198754;">
                                    <th style="padding: 15px; text-align: left; font-weight: bold;">User</th>
                                    <th style="padding: 15px; text-align: left; font-weight: bold;">Email</th>
                                    <th style="padding: 15px; text-align: left; font-weight: bold;">Role</th>
                                    <th style="padding: 15px; text-align: left; font-weight: bold;">Status</th>
                                    <th style="padding: 15px; text-align: left; font-weight: bold;">Joined</th>
                                    <th style="padding: 15px; text-align: center; font-weight: bold;">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for user in users %}
                                <tr style="border-bottom: 1px solid #eee; background: {% cycle 'white' '#f9f9f9' %};">
                                    <td style="padding: 15px;">
                                        <div style="display: flex; align-items: center;">
                                            <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #198754, #20c997); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; margin-right: 12px;">
                                                {{ user.username|slice:":1"|upper }}
                                            </div>
                                            <div>
                                                <strong>{{ user.username }}</strong>
                                                <div style="font-size: 12px; color: #666;">
                                                    {% if user.first_name or user.last_name %}
                                                        {{ user.first_name }} {{ user.last_name }}
                                                    {% else %}
                                                        No full name set
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                    </td>
                                    <td style="padding: 15px;">
                                        <a href="mailto:{{ user.email }}" style="color: #198754; text-decoration: none;">
                                            {{ user.email }}
                                        </a>
                                    </td>
                                    <td style="padding: 15px;">
                                        {% if user.is_staff %}
                                            <span style="background: #007bff; color: white; padding: 4px 12px; border-radius: 15px; font-size: 12px; font-weight: bold;">STAFF</span>
                                        {% else %}
                                            <span style="background: #28a745; color: white; padding: 4px 12px; border-radius: 15px; font-size: 12px; font-weight: bold;">USER</span>
                                        {% endif %}
                                    </td>
                                    <td style="padding: 15px;">
                                        {% if user.is_active %}
                                            <span style="background: #d1ecf1; color: #0c5460; padding: 4px 12px; border-radius: 15px; font-size: 12px; font-weight: bold;">ACTIVE</span>
                                        {% else %}
                                            <span style="background: #f8d7da; color: #721c24; padding: 4px 12px; border-radius: 15px; font-size: 12px; font-weight: bold;">INACTIVE</span>
                                        {% endif %}
                                    </td>
                                    <td style="padding: 15px;">
                                        <div>{{ user.date_joined|date:"M d, Y" }}</div>
                                        <small style="color: #666;">{{ user.date_joined|timesince }} ago</small>
                                    </td>
                                    <td style="padding: 15px; text-align: center;">
                                        <div style="display: flex; gap: 5px; justify-content: center;">
                                            <a href="{% url 'admin_user_edit' user.id %}" 
                                               style="padding: 6px 12px; background: #007bff; color: white; text-decoration: none; border-radius: 5px; font-size: 12px;">
                                                <i class="fas fa-edit"></i> Edit
                                            </a>
                                            {% if not user.is_staff or user != request.user %}
                                            <button onclick="toggleUserStatus({{ user.id }}, '{{ user.username }}', {{ user.is_active|yesno:'true,false' }})" 
                                                    style="padding: 6px 12px; background: {% if user.is_active %}#dc3545{% else %}#28a745{% endif %}; color: white; border: none; border-radius: 5px; font-size: 12px; cursor: pointer;">
                                                {% if user.is_active %}
                                                    <i class="fas fa-ban"></i> Disable
                                                {% else %}
                                                    <i class="fas fa-check"></i> Enable
                                                {% endif %}
                                            </button>
                                            {% endif %}
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <i class="fas fa-users" style="font-size: 48px; margin-bottom: 15px; opacity: 0.5;"></i>
                        <h3>No Users Found</h3>
                        <p>No users match the current filter criteria.</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <script>
    function filterUsers(type) {
        window.location.href = `{% url 'admin_users_management' %}?type=${type}`;
    }

    function toggleUserStatus(userId, username, isActive) {
        const action = isActive ? 'deactivate' : 'activate';
        if (confirm(`Are you sure you want to ${action} user "${username}"?`)) {
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = `/manage/users/${userId}/edit/`;
            
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                             document.querySelector('meta[name="csrf-token"]')?.content;
            
            if (csrfToken) {
                const csrfInput = document.createElement('input');
                csrfInput.type = 'hidden';
                csrfInput.name = 'csrfmiddlewaretoken';
                csrfInput.value = csrfToken;
                form.appendChild(csrfInput);
            }

            const actionInput = document.createElement('input');
            actionInput.type = 'hidden';
            actionInput.name = 'action';
            actionInput.value = 'toggle_active';
            form.appendChild(actionInput);
            
            document.body.appendChild(form);
            form.submit();
        }
    }

    function toggleSidebar() {
        const sidebar = document.getElementById('sidebar');
        sidebar.classList.toggle('active');
    }

    // Table row hover effects
    document.querySelectorAll('tbody tr').forEach(row => {
        row.addEventListener('mouseenter', function() {
            this.style.backgroundColor = '#f0f8f0';
            this.style.transform = 'scale(1.01)';
            this.style.transition = 'all 0.2s ease';
        });
        
        row.addEventListener('mouseleave', function() {
            this.style.backgroundColor = '';
            this.style.transform = 'scale(1)';
        });
    });
    </script>
</body>
</html>
